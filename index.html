<!DOCTYPE html>
<html>
	<head>
		<title>WebSocket Echo Test</title>

		<script src="https://unpkg.com/htmx.org@1.9.12" integrity="sha384-ujb1lZYygJmzgSwoxRggbCHcjc0rB2XoQrxeTUQyRjrOnlCoYta87iKBWq3EsdM2" crossorigin="anonymous"></script>
		<script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/ws.js"></script>


		<link rel="stylesheet" href="static/style.css">


	</head>
	<body>
		<h1>WebSocket Echo Test</h1>






		status:
		<div id="status"></div>


		<div hx-ext="ws" ws-connect="/ws">


			count:
			<div id="count"></div>

			artist:
			<div id="artist-name"></div>

			trackname:
			<div id="track-name"></div>

			stationname:
			<div id="station-name"></div>


			<audio id="audio-player" controls > <source src="/station/0" type="audio/mpeg"> </audio>

			<button id="button-ws-prev" ws-send hx-vals='{"action": "previous"}' > Previous Station </button>
			<button id="button-ws-next" ws-send hx-vals='{"action": "next"}' > Next Station </button>

		</div>





		<script type="text/javascript" defer>
			let status = document.getElementById('status');

			// htmx:wsConnecting
			// htmx:wsError

			let socket;
			let elt;

			document.addEventListener("visibilitychange", function(evt) {
				console.log('visibilitychange', document.visibilityState);
				if (socket) {
					socket.send(document.visibilityState, elt);
				}
			});

			document.body.addEventListener('htmx:wsAfterMessage', function(evt) {
				console.log('message in htmx');
				console.log(evt.detail.message);
				console.log('message in htmx end');

			});

			document.body.addEventListener('htmx:wsOpen', function(evt) {
				console.log('connected');

				socket = evt.detail.socketWrapper;
				elt = evt.detail.elt;

				status.innerText = 'Connected';
				status.setAttribute('data-status', 'connected');
			});
			document.body.addEventListener('htmx:wsClose', function(evt) {
				console.log('disconnected');
				status.innerText = 'Disconnected';
				status.setAttribute('data-status', 'disconnected');
			});
		</script>






		<input type="text" id="message" placeholder="Type a message...">
		<button onclick="sendMessage()">Send</button>
		<hr>
		<div id="output"></div>

		<script>
			let secure = window.location.protocol.includes('https') ? 's':'';
			var socket2 = new WebSocket("ws"+secure+"://" + window.location.host + "/ws");

			socket2.onopen = function(event) {
				console.log("WebSocket connected!");
			}

			//socket2.onmessage = function(event) {
				//	console.log("Received message:", event.data);
				//	document.getElementById("output").innerHTML += event.data + "<br>";
				//}

			function sendMessage() {
				var message = document.getElementById("message").value;
				socket2.send(message);
				document.getElementById("message").value = "";
				console.log("Sent message:", message);
			}
		</script>
	</body>
</html>
